{
  "status": "DONE",
  "description": "# Ì¥¥ Bug: GET /api/agent/tasks/:id/comments retorna 405\n\n## ‚úÖ RESOLVIDO\n\n### Problema\nEndpoint documentado retornava **405 Method Not Allowed** quando chamado via GET.\nArquivo `route.ts` **s√≥ implementava POST**, faltava implementar GET.\n\n### Solu√ß√£o Aplicada\n\n**Arquivo modificado**: [src/app/api/agent/tasks/[id]/comments/route.ts](d:\\Users\\Guilherme\\Documents\\development\\jt-kill\\src\\app\\api\\agent\\tasks\\[id]\\comments\\route.ts)\n\n**Mudan√ßas:**\n1. ‚úÖ Adicionado handler `GET` que lista coment√°rios da task\n2. ‚úÖ Valida√ß√£o de `taskId` (formato UUID)\n3. ‚úÖ Verifica√ß√£o de permiss√£o (task pertence √† org)\n4. ‚úÖ Usa `commentRepository.findByTaskId()` existente\n5. ‚úÖ Retorna lista com `agentList()` para manter padr√£o da API\n\n**C√≥digo implementado:**\n```typescript\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { orgId } = await extractAgentAuth();\n    const { id: taskId } = await params;\n\n    if (!z.string().uuid().safeParse(taskId).success) {\n      return agentError('VALIDATION_ERROR', 'Invalid task ID', 400);\n    }\n\n    // Verify task exists and belongs to org\n    const task = await taskRepository.findById(taskId, orgId);\n    if (!task) {\n      return agentError('NOT_FOUND', 'Task not found', 404);\n    }\n\n    // List comments ordered by creation date\n    const comments = await commentRepository.findByTaskId(taskId, orgId);\n\n    return agentList(comments, comments.length);\n  } catch (error) {\n    return handleAgentError(error);\n  }\n}\n```\n\n### Response Format\n```json\n{\n  \"success\": true,\n  \"data\": [\n    {\n      \"id\": \"uuid\",\n      \"taskId\": \"uuid\",\n      \"userId\": \"uuid\",\n      \"content\": \"string\",\n      \"createdAt\": \"ISO date\",\n      \"user\": {\n        \"id\": \"uuid\",\n        \"displayName\": \"string\",\n        \"avatarUrl\": \"url | null\"\n      }\n    }\n  ],\n  \"meta\": { \"total\": 5 }\n}\n```\n\n### Quality Gates\n- ‚úÖ **TypeCheck**: PASS (`npx tsc --noEmit`)\n- ‚úÖ **Implementa√ß√£o**: M√©todo GET adicionado\n- ‚úÖ **Valida√ß√£o**: Task ID e org verificados\n- ‚úÖ **Erro handling**: 404 para task inexistente\n- ‚è≥ **Deploy**: Aguardando deploy para produ√ß√£o\n\n### Testes Manuais (P√≥s-Deploy)\n```bash\n# GET comments de uma task\ncurl \"https://jt-kill.vercel.app/api/agent/tasks/TASK_UUID/comments\" \\\n  -H \"Authorization: Bearer agk_xxx\"\n\n# Deve retornar 200 com array de comments\n# Antes: 405 Method Not Allowed ‚ùå\n# Depois: 200 OK com dados ‚úÖ\n```\n\n### Impacto\n‚úÖ Agents agora podem fazer an√°lise profunda de tasks via coment√°rios  \n‚úÖ Hist√≥rico de decis√µes acess√≠vel para audit/code review  \n‚úÖ Workflows de `jtk-readonly-audit.js` funcionam corretamente  \n\n---\n\n## Problema Original\nEndpoint documentado retorna **405 Method Not Allowed** quando chamado.\nIsso bloqueia agents de fazer an√°lise profunda de tasks via coment√°rios.\n\n## Como Reproduzir (antes do fix)\n1. Pegar qualquer taskId v√°lido\n2. Fazer GET /api/agent/tasks/:id/comments\n3. Observar erro 405 ‚ùå\n\n## Solu√ß√£o Esperada\n- Habilitar m√©todo GET no endpoint ‚úÖ\n- Retornar array de coment√°rios conforme documenta√ß√£o ‚úÖ\n- Manter consist√™ncia com POST /comments que funciona ‚úÖ\n"
}
