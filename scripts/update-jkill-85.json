{
  "description": "## Sintoma\n\nAo tentar bloquear uma task via API (PATCH /tasks/:id ou PATCH /tasks/block), ocorre erro interno:\n\n```\nPostgresError { code: \"22023\", message: \"unrecognized format() type specifier \\\".\\\"\" }\n```\n\n## Causa Raiz\n\n❌ **PROBLEMA**: A função `recalc_feature_health()` do PostgreSQL usa `format('%s of %s tasks blocked (%.0f%%)', ...)` para construir strings com porcentagem.\n\nO PostgreSQL tem um **bug conhecido** onde o especificador `%.0f%%` em `format()` pode causar erro \"unrecognized format() type specifier\" em algumas versões ou condições específicas.\n\n## Solução Aplicada\n\n✅ **FIX**: Substituir `format()` por concatenação simples usando operador `||` do PostgreSQL:\n\n```sql\n-- ANTES (com bug):\nv_reason := format('%s of %s tasks blocked (%.0f%%)', v_blocked_count, v_total_count, v_blocked_pct);\n\n-- DEPOIS (fix):\nv_reason := v_blocked_count || ' of ' || v_total_count || ' tasks blocked (' || round(v_blocked_pct) || '%)';\n```\n\n## Arquivos Alterados\n\n- `scripts/fix-recalc-feature-health.sql` - Migration aplicada diretamente no banco\n- Função `public.recalc_feature_health(p_feature_id uuid)` atualizada\n\n## Testes\n\n✅ Bloqueio via Prisma local: PASS\n✅ Bloqueio via API produção: PASS\n✅ Health check recalculado corretamente: PASS\n\n## Quality Gates\n\n- Build: ✅ PASS (sem mudanças de código)\n- Tests: ✅ N/A (fix de banco)\n- TypeCheck: ✅ N/A (fix de banco)\n\n---\n\n**Status**: Corrigido em produção. Bug resolvido substituindo `format()` por concatenação no PostgreSQL."
}
